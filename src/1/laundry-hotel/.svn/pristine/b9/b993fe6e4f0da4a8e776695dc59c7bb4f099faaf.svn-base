@{
    ViewBag.Tag = "Sys_Right";
}

<div class="ibox-content">
    <div style="margin-bottom:20px;">
        <button class="btn btn-primary " type="button" onclick="Add()"><i class="fa fa-plus"></i>&nbsp;添加</button>
        <button class="btn btn-warning " type="button" onclick="Modify()"><i class="fa fa-pencil"></i>&nbsp;修改</button>
        <button class="btn btn-danger " type="button" onclick="Remove()"><i class="fa fa-trash-o"></i>&nbsp;删除</button>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover dataTables-example">
            <thead>
                <tr>
                    <th></th>
                    <th>ID</th>
                    <th>系统模块</th>
                    <th>功能名称</th>
                    <th>功能编码</th>
                    <th>父级ID</th>
                    <th>排序</th>
                    <th>路径</th>
                    <th>Icon</th>
                    <th>类别</th>
                    <th>菜单可见</th>
                    <th>设置</th>
                </tr>
            </thead>
            <tbody></tbody>

        </table>
    </div>

</div>
<div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">系统模块添加</h4>
            </div>
            <form class="form-horizontal" id="addRightForm">
                <div class="modal-body">
                    <div class="form-group">
                        <input type="hidden" id="RightID" value="0" />
                        <label class="col-lg-2 control-label">功能名称</label>
                        <div class="col-lg-10">
                            <input type="text" id="RightName" class="form-control" required="" onblur="checkRightName(this)" />
                        </div>
                    </div>
                    <div class="form-group" style="display:none;">
                        <label class="col-lg-2 control-label">功能编码</label>
                        <div class="col-lg-10">
                            <input type="text" id="RightCode" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">系统模块</label>
                        <div class="col-lg-10">
                            <select class="form-control" id="ApplicationID">
                                @{ var appList = ViewData["AppList"] as List<ETexsys.Model.sys_application>; }
                                @foreach (var item in appList)
                                {
                                    <option value="@item.ApplicationID">@item.ApplicationName</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">父级功能</label>
                        <div class="col-lg-10">
                            <select class="form-control" id="RightParentID"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">排序</label>
                        <div class="col-lg-10">
                            <input type="number" id="RightSort" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">URL</label>
                        <div class="col-lg-10">
                            <input type="text" id="RightUrl" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Icon</label>
                        <div class="col-lg-10">
                            <input type="text" id="RightIcon" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">类型</label>
                        <div class="col-lg-10">
                            <select class="form-control" id="RightType">
                                <option value="1">功能</option>
                                <option value="2">Api</option>
                            </select>
                        </div>
                    </div><div class="form-group">
                        <label class="col-lg-2 control-label"></label>
                        <div class="col-lg-10">
                            <div class="i-checks"><label> <input type="checkbox" id="ShowInMainMenu" checked="checked" value=""> <i></i> 菜单可见 </label></div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal inmodal" id="myBtnModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">功能按钮</h4>
            </div>
            <form class="form-horizontal" id="settingForm">
                <div class="modal-body">
                    <div class="form-group">
                        <div class="col-sm-10">
                            <input type="hidden" id="settingRightID" value="0" />
                            <label class="checkbox-inline">
                                <input type="checkbox" value="add" id="cbadd">添加
                            </label><label class="checkbox-inline">
                                <input type="checkbox" value="update" id="cbupdate">修改
                            </label> <label class="checkbox-inline">
                                <input type="checkbox" value="delete" id="cbdel">删除
                            </label><label class="checkbox-inline">
                                <input type="checkbox" value="setting" id="cbset">设置
                            </label>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.i-checks').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
        });
        $("#RightParentID").append("<option value=''></option>");
        var url = "@Url.Action("GetSys_RightList", "SysAdmin")";
        $('.dataTables-example').DataTable({
            bAutoWidth: false,
            aoColumns: [
               {
                   "sClass": "text-center",
                   "data": "RightID",
                   "render": function (data, type, full, meta) {
                       return '<input type="radio" name="a"  class="checkchild"  value="' + data + '" />';
                   },
                   "bSortable": false
               },
                { "sClass": "center", "mDataProp": "RightID", "bSortable": false },
                { "sClass": "center", "mDataProp": "ApplicationName", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightName", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightCode", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightParentID", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightSort", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightUrl", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightIcon", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightType", "bSortable": false },
                { "sClass": "center", "mDataProp": "ShowInMainMenu", "bSortable": false },
                { "sClass": "center", "mDataProp": "RightID", "bSortable": false }
            ],
            "bServerSide": true,//分页，取数据等等的都放到服务端去
            "bProcessing": true,//载入数据的时候是否显示“载入中”
            "aLengthMenu": [30, 50, 100],
            "bLengthChange": false, //改变每页显示数据数量
            "bFilter": false, //过滤功能
            "iDisplayStart": 0,
            "iDisplayLength": 30,//首次加载的数据条数
            "bStorable": true,//排序操作在服务端进行，所以可以关了。
            "sAjaxSource": url,
            "fnServerData": function (sSource, aoData, fnCallback, bStorable) {
                var paramList = {
                    "sEcho": 0,
                    "iDisplayLength": 0,
                    "iDisplayStart": 0,
                    "sSortDir_0": bStorable.aaSorting[0][1],
                    "iSortCol_0": bStorable.aaSorting[0][0],
                };
                if (bStorable.aaSorting[0][0] == 0) {
                    paramList.isDesc = true;
                }
                for (var i = 0; i < aoData.length; i++) {
                    if (aoData[i].name == "iDisplayStart") {
                        paramList.iDisplayStart = aoData[i].value;
                    } else if (aoData[i].name == "iDisplayLength") {
                        paramList.iDisplayLength = aoData[i].value;
                    } else
                        if (aoData[i].name == "sEcho") {
                            paramList.sEcho = aoData[i].value;
                        }
                }
                $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": sSource,
                    "data": paramList,
                    "success": function (resp) {
                        fnCallback(resp); //服务器端返回的对象的returnObject部分是要求的格式
                    }
                });
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex) {

                var html = aData.ShowInMainMenu ? '<span class="label" style="background:#56af45;color:#fff;">可见</span>' : '<span class="label" style="background:#f00;color:#fff;">不可见</span>';
                $('td:eq(10)', nRow).html(html);

                html = aData.RightType == 1 ? "功能" : "API";
                $('td:eq(9)', nRow).html(html);

                $("#RightParentID").append("<option value='" + aData.RightID + "'>" + aData.RightName + "</option>");

                html = '<a class="btn btn-white btn-sm" href="javascript:btnSetting(\'' + aData.RightID + '\')" title="设置">设置</a>';
                $('td:eq(11)', nRow).html(html);

                return nRow;

            },
            dom: '<"html5buttons"B>lTfgitp',
            buttons: [
                { extend: 'copy' },
                { extend: 'csv' },
                { extend: 'excel', title: 'ExampleFile' },
                { extend: 'pdf', title: 'ExampleFile' },

                {
                    extend: 'print',
                    customize: function (win) {
                        $(win.document.body).addClass('white-bg');
                        $(win.document.body).css('font-size', '10px');

                        $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', 'inherit');
                    }
                }
            ],
            "oLanguage": {
                "sLengthMenu": "每页显示 _MENU_ 条记录",
                "sZeroRecords": "抱歉， 没有找到",
                "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                "sInfoEmpty": "没有数据",
                "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "前一页",
                    "sNext": "后一页",
                    "sLast": "尾页"
                },
                "sZeroRecords": "没有检索到数据",
                "sProcessing": "<img src='./loading.gif' />"
            }
        });

    });

    function Add() {
        $("#RightID").val("0");
        $("#RightName").nextAll().remove();
        document.getElementById("addRightForm").reset();
        $("#myModal .modal-title").html("系统模块添加");
        $('#myModal').modal('show');
    }

    function Modify() {
        $("#RightName").nextAll().remove();
        var val = $(".dataTables-example input[type='radio']:checked").val();
        if (val == null) {
            swal("提示", "请先选择记录.");

            return false;
        }
        var url = "@Url.Action("GetSys_Right", "SysAdmin")";
        document.getElementById("addRightForm").reset();//清空表单
        $.ajax({
            type: "post",
            data: { RightID: val },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $("#myModal .modal-title").html("功能更新");
                    $("#RightID").val(result.Result.RightID);
                    $("#RightName").val(result.Result.RightName);
                    $("#RightParentID").val(result.Result.RightParentID);
                    $("#RightCode").val(result.Result.RightCode);
                    $("#RightSort").val(result.Result.RightSort);
                    $("#RightUrl").val(result.Result.RightUrl);
                    $("#RightIcon").val(result.Result.RightIcon);
                    $("#ApplicationID").val(result.Result.ApplicationID);
                    $("#RightType").val(result.Result.RightType);
                    if (result.Result.ShowInMainMenu) {
                        $("#ShowInMainMenu").iCheck("check");
                    } else {
                        $("#ShowInMainMenu").iCheck("uncheck");
                    }
                    $('#myModal').modal('show');
                } else {
                    swal({ title: "提示", text: "获取信息失败", type: "error" });
                }
            }
        });
    }

    function Remove() {
        var val = $(".dataTables-example input[type='radio']:checked").val();
        if (val == null) {
            swal("提示", "请先选择记录.");

            return false;
        }
        swal({
            title: "您确定要删除吗？",
            text: "您确定要删除这条数据？",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("DelSys_Right","SysAdmin")";
            $.ajax({
                type: "post",
                data: { RightID: val },
                url: url,
                async: false,
                success: function (result) {
                    if (result.ResultCode == "0") {
                        swal("Good!", "删除成功", "success");
                        $("#RightParentID").empty();
                        $("#RightParentID").append("<option value=''></option>");
                        $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                    } else {
                        swal({ title: "提示", text: "删除失败", type: "error" });
                    }
                }
            });
        });
    }

    function checkRightName(obj) {
        var url = "@Url.Action("CheckRightName", "SysAdmin")";
        $.ajax({
            type: "post",
            data: { rightId: $("#RightID").val(), rightName: $("#RightName").val() },
            url: url,
            async: false,
            success: function (result) {
                if (result) {
                    $(obj).nextAll().remove();
                } else {
                    $(obj).nextAll().remove();
                    $(obj).after('<p class="help-block"  style="color:red">功能名称已存在</p>');
                }
            }
        });
    }

    $("#addRightForm").submit(function () {
        var _url = "@Url.Action("CheckRightName", "SysAdmin")";
        $.ajax({
            type: "post",
            data: { rightId: $("#RightID").val(), rightName: $("#RightName").val() },
            url: _url,
            success: function (result) {
                if (result) {
                    $("#RightName").nextAll().remove();

                    var url = "@Url.Action("AddSys_Right","SysAdmin")";
                    if ($("#RightID").val() != "0") {
                        url = "@Url.Action("UpdateSys_Right", "SysAdmin")";
                    }
                    $.ajax({
                        type: "post",
                        data: {
                            RightID: $("#RightID").val(), RightName: $("#RightName").val(), RightParentID: $("#RightParentID").val(), RightUrl: $("#RightUrl").val(), RightType: $("#RightType").val(),
                            ApplicationID: $("#ApplicationID").val(), RightCode: $("#RightCode").val(), RightIcon: $("#RightIcon").val(), RightSort: $("#RightSort").val(), ShowInMainMenu: $("#ShowInMainMenu").is(":checked")
                        },
                        url: url,
                        async: false,
                        success: function (result) {
                            if (result.ResultCode == "0") {
                                $('#myModal').modal('hide');//关闭模态框
                                document.getElementById("addRightForm").reset();//清空表单
                                $("#RightParentID").empty();
                                $("#RightParentID").append("<option value=''></option>");
                                $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                            } else {
                                swal({
                                    title: "提示",
                                    text: "添加失败"
                                });
                            }
                        }
                    });
                } else {
                    $("#RightName").nextAll().remove();
                    $("#RightName").after('<p class="help-block"  style="color:red">功能名称已存在</p>');
                }
            }
        });
        return false;
    });

    function btnSetting(id) {
        var url = "@Url.Action("GetSettingRightList", "SysAdmin")";
        $("#cbadd").iCheck('uncheck'); $("#cbupdate").iCheck('uncheck'); $("#cbdel").iCheck('uncheck'); $("#cbset").iCheck('uncheck');
        $.ajax({
            type: "post",
            data: { rightID: id },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    var list = result.Result;
                    $.each(list, function (i, item) {
                        switch (item.BtnCode) {
                            case "Add":
                                $("#cbadd").iCheck('check');
                                break;
                            case "Update":
                                $("#cbupdate").iCheck('check');
                                break;
                            case "Delete":
                                $("#cbdel").iCheck('check');
                                break;
                            case "Setting":
                                $("#cbset").iCheck('check');
                                break;
                        }
                    });
                    $('#myBtnModal').modal('show');
                    $("#settingRightID").val(id);
                }
            }
        });
    }

    $("#settingForm").submit(function () {
        var url = "@Url.Action("SettingRightBtn","SysAdmin")";

        $.ajax({
            type: "post",
            data: { RightID: $("#settingRightID").val(), Add: $("#cbadd").is(":checked"), Update: $("#cbupdate").is(":checked"), Del: $("#cbdel").is(":checked"), Setting: $("#cbset").is(":checked") },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $('#myBtnModal').modal('hide');//关闭模态框
                    document.getElementById("settingForm").reset();//清空表单
                } else {
                    swal({
                        title: "提示",
                        text: "添加失败"
                    });
                }
            }
        });
        return false;
    });



</script>