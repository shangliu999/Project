@{
    Layout = null;
}
<div class="row wrapper wrapper-content animated fadeInRight" style="padding-top:75px;">
    <div class="ibox-content">
        <div>
            <h1>需求申请</h1>
        </div>
        <div class="ibox-content">
            <form class="form-horizontal" id="DemandApplyForm">
                <div class="form-group">
                    <input type="hidden" id="hidBid" value="0" />
                    <label class="col-lg-1 control-label">酒店</label>
                    <div class="col-lg-2">
                        <select id="HotelId" class="form-control">
                            @{ var hotelList = ViewData["HotelList"] as List<ETexsys.Model.region>;}
                            @foreach (var item in hotelList)
                            {
                                <option value="@item.ID">@item.RegionName</option>
                            }
                        </select>
                    </div>
                    <label class="col-lg-1 control-label">类型</label>
                    <div class="col-lg-2">
                        <select id="SubType" class="form-control">
                            <option value="1">投放</option>
                            <option value="2">借用</option>
                        </select>
                    </div>
                </div>
                @{
                    var classList = ViewData["ClassList"] as List<ETexsys.Model.textileclass>;
                }
                <div style="border: 1px solid #19aa8d; padding-top: 10px; margin-bottom: 10px;">
                    <div class="form-group">
                        <label class="col-lg-1 control-label">名称：</label>
                        <div class="col-lg-2">
                            <select class="form-control" id="classId" onchange="loadSizeList(this)">

                                @foreach (var item in classList)
                                {
                                    <option value="@item.ID">@item.ClassName</option>
                                }
                            </select>
                        </div>
                        <label class="col-lg-1 control-label">尺寸：</label>
                        <div class="col-lg-2">
                            <select id="sizeId" class="form-control"></select>
                        </div><label class="col-lg-1 control-label">数量：</label>
                        <div class="col-lg-2">
                            <input id="txtCount" type="number" onkeyup="value=value.replace(/[^\d]/g,'')" onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))" class="form-control" />
                        </div>
                        <div class="col-lg-2">
                            <a class="btn btn-primary" data-toggle="modal" href="" onclick="addRow()" title="添加">
                                <i class="ui-icon fa fa-plus bigger-120"></i>
                                添加
                            </a>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="table-responsive dataTables_wrapper" style="margin-left:30px;margin-right:30px;">
                        <table id="textile-table" class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>纺织品名称</th>
                                    <th>尺寸</th>
                                    <th>数量</th>
                                    <th>删除</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-1 control-label" style="text-align: right;">备注：</label>
                    <div class="col-lg-8">
                        <textarea name="note" id="note" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-lg-9 col-lg-offset-3">
                        <button class="btn btn-primary" type="submit" id="btnSubmit">
                            <i class="icon-ok bigger-110"></i>
                            提交
                        </button>
                        <button class="btn" type="reset" id="btnReset">
                            <i class="icon-undo bigger-110"></i>
                            取消
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function loadSizeList(obj) {
        var _url = "@Url.Action("GetSizeByClassId", "Demand")";
        var id = $(obj).val();
        if (id != "") {
            $.ajax({
                type: "post",
                data: { classId: id },
                url: _url,
                success: function (result) {
                    $("#sizeId").children().remove();
                    var options = '';
                    $.each(result.Result, function (i, item) {
                        options += '<option value="' + item.ID + '">' + item.SizeName + '</option>';
                    });
                    $("#sizeId").append(options);
                }
            });
        } else {
            $("#sizeId").children().remove();
        }
    }

    loadSizeList($("#classId"));

    var arrObj = new Array();

    function addRow() {
        if ($("#classId").val() == "") {
            $("#classId").addClass("input-error");
            return;
        } else {
            $("#classId").removeClass("input-error");
        }
        var c = $("#txtCount").val();
        var count = parseInt(c);
        if (isNaN(count) || count <= 0) {
            $("#txtCount").addClass("input-error");
            return;
        } else {
            $("#txtCount").removeClass("input-error");
        }


        var classId = $("#classId").val();
        var className = $("#classId").find("option:selected").text();
        var sizeId = $("#sizeId").val();
        var sizeName = $("#sizeId").find("option:selected").text()

        var myDate = new Date();
        var guid = myDate.getFullYear().toString() + myDate.getMonth().toString() + myDate.getDate().toString() + myDate.getHours().toString() + myDate.getMinutes().toString() + myDate.getSeconds().toString();

        var isAppend = 0;
        $.each(arrObj, function (n, item) {
            if (item.ClassID == classId && item.SizeID == sizeId) {
                isAppend = 1;
            }
        });
        if (isAppend == 1) {
            return;
        }

        arrObj.push({ Guid: guid, ClassID: classId, ClassName: className, SizeName: sizeName, SizeID: sizeId, TextileCount: count });

        var tr = $('<tr></tr>').attr("data-value", guid);
        var textiletd = $('<td></td>');
        $(textiletd).html($("#classId").find("option:selected").text()).appendTo(tr);
        var sizetd = $('<td></td>');
        $(sizetd).html($("#sizeId").find("option:selected").text()).appendTo(tr);
        var counttd = $('<td></td>').html("<input name='textileCount' type='number' value='" + count + "' />").appendTo(tr);
        $('<td></td>').html('<a class="btn btn-xs btn-danger" onclick="javascript:removeRow(this,\'' + guid + '\')"><i class="ace-icon fa fa-trash-o bigger-120"></i></a>').appendTo(tr);
        $(tr).appendTo($("#textile-table tbody"));

        $("#txtCount").val('');
    }

    function removeRow(obj, guid) {
        $(obj).parent().parent().remove();
        for (var i = 0; i < arrObj.length; i++) {
            if (arrObj[i].Guid == guid) {
                arrObj.splice(i, 1);
            }
        }
    }

    $("#DemandApplyForm").submit(function () {
        if ($("#HotelId").val() == null || $("#HotelId").val() == "") {
            swal("提示", "请先选择酒店.");
            return false;
        }

        if (arrObj.length != $("#textile-table tbody tr").length) {
            swal("提示", "非法操作，请刷新浏览器再试.");
            return false;
        }

        if (arrObj.length == 0) {
            swal("提示", "请先录入数据再进行申请.");
            return false;
        }

        $("#textile-table tbody tr").each(function (i, item) {
            var gid = $(item).attr("data-value");
            for (var i = 0; i < arrObj.length; i++) {
                if (arrObj[i].Guid == gid) {
                    arrObj[i].TextileCount = $(item).find("input[name='textileCount']").val();
                }
            }
        });
        var _url = "@Url.Action("AddApply", "Demand")";
        if ($("#hidBid").val() != "0") {
            _url = "@Url.Action("UpdateApply", "Demand")";
        }

        $.ajax({
            type: "post",
            data: { BID: $("#hidBid").val(), HotelID: $("#HotelId").val(), SubType: $("#SubType").val(), Note: $("#note").val(), DataLength: arrObj.length, Data: arrObj },
            url: _url,
            success: function (result) {
                if (result.ResultCode == "0") {
                    arrObj = new Array();
                    $("#textile-table tbody").empty();
                    if ($("#hidBid").val() != "0") {
                        swal("提示", " 修改成功.");
                    } else {
                        swal("提示", " 申请成功.");
                    }
                    $("#hidBid").val("0");
                    $("#HotelId option:first").prop("selected", 'selected');
                    $("#HotelId option:first").attr("selected", 'selected');
                    $("#SubType option:first").prop("selected", 'selected');
                    $("#SubType option:first").attr("selected", 'selected');

                } else {
                    swal({ title: "提示", text: "申请失败，请稍后再试，或者联系管理员.", type: "error" });
                }
            }
        });
        return false;
    });

    function loadApply(id) {
        var _url = "@Url.Action("GetApplyById", "Demand")";
        $.ajax({
            type: "post",
            data: { bid: id },
            url: _url,
            success: function (result) {
                if (result.ResultCode == 0) {
                    var invModel = result.Result;

                    $("#HotelId").val(invModel.HotelID);
                    $("#SubType").val(invModel.SubType);

                    var invDetail = result.OtherResult;

                    $.each(invDetail, function (i, item) {
                        var myDate = new Date();
                        var guid = myDate.getFullYear().toString() + myDate.getMonth().toString() + myDate.getDate().toString() + myDate.getHours().toString() + myDate.getMinutes().toString() + myDate.getSeconds().toString() + i.toString();

                        arrObj.push({ Guid: guid, ClassID: item.ClassID, ClassName: item.ClassName, SizeName: item.SizeName, SizeID: item.SizeID == 0 ? undefined : item.SizeID, TextileCount: item.TextileCount });

                        var tr = $('<tr></tr>').attr("data-value", guid);
                        var textiletd = $('<td></td>');
                        $(textiletd).html(item.ClassName).appendTo(tr);
                        var sizetd = $('<td></td>');
                        $(sizetd).html(item.SizeName).appendTo(tr);
                        var counttd = $('<td></td>').html("<input name='textileCount' type='number' value='" + item.TextileCount + "' />").appendTo(tr);
                        $('<td></td>').html('<a class="btn btn-xs btn-danger" onclick="javascript:removeRow(this,\'' + guid + '\')"><i class="ace-icon fa fa-trash-o bigger-120"></i></a>').appendTo(tr);
                        $(tr).appendTo($("#textile-table tbody"));
                    });
                }
            }
        });
    }

    var id = "@ViewData["BID"]";
    if (id != null && id != "") {
        $("#hidBid").val(id);
        loadApply(id);
    }

</script>
