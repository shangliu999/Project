@{
    Layout = null;
}
<script src="@Url.Content("~/Scripts/jquery.md5.js")"></script>
<link href="@Url.Content("~/Content/plugins/treegrid/jquery.treegrid.css")" rel="stylesheet" />
<script src="@Url.Content("~/Scripts/plugins/treegrid/jquery.treegrid.min.js")"></script>
<script src="@Url.Content("~/Scripts/plugins/treegrid/jquery.treegrid.bootstrap3.js")"></script>
<script src="@Url.Content("~/Scripts/plugins/treegrid/jquery.treegrid.extension.js")"></script>
<script src="@Url.Content("~/Scripts/jquery.qrcode.min.js")"></script>
<script src="@Url.Content("~/Scripts/ConfigJs.js")"></script>
<div class="row wrapper wrapper-content animated fadeInRight" style="padding-top:75px;">
    <div class="ibox-content">
        <div style="margin-bottom:20px;">
            @Html.ToolButton(ViewData["BtnList"] as List<ETexsys.Model.sys_right_button>)
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover dataTables-example">
                <thead>
                    <tr>
                        <th></th>
                        <th>登录名</th>
                        <th>姓名</th>
                        <th>角色</th>
                        <th>所在仓库</th>
                        <th>部门</th>
                        <th>职位</th>
                        <th>电话</th>
                        <th>邮箱</th>
                        <th>最后上线时间</th>
                        <th>状态</th>
                        <th>微信</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    <div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">用户添加</h4>
                </div>
                <form class="form-horizontal" id="addUserForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <input type="hidden" id="UserID" value="0" />
                            <label class="col-lg-2 control-label">登录名称</label>
                            <div class="col-lg-10"><input type="text" id="LoginName" class="form-control" required="" onblur="checkUserName(this)" /></div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">登录密码</label>
                            <div class="col-lg-10"><input type="password" id="LoginPwd" class="form-control" required="" /></div>
                        </div>
                        <div class="form-group">
                            <input type="hidden" id="UserID" value="0" />
                            <label class="col-lg-2 control-label">姓名</label>
                            <div class="col-lg-10"><input type="text" id="UName" class="form-control" required="" /></div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">所在仓库</label>
                            <div class="col-lg-10">
                                <select class="form-control" id="StoreID">
                                    @{ var regList = ViewData["RegionList"] as List<ETexsys.Model.region>;}
                                    @for (var i = 0; i < regList.Count; i++)
                                    {
                                        var item = regList[i];
                                        if (i == 0)
                                        {
                                            <option value="@item.ID" data-StoreType="@item.RegionMode" selected="selected">@item.RegionName</option>
                                        }
                                        else
                                        {
                                            <option value="@item.ID" data-StoreType="@item.RegionMode">@item.RegionName</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">部门</label>
                            <div class="col-lg-10">
                                <select class="form-control" id="OrganiseID">
                                    @{ var orgList = ViewData["OrgList"] as List<ETexsys.Model.organise>;}
                                    @foreach (var item in orgList)
                                    {
                                        <option value="@item.ID">@item.FullName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">职位</label>
                            <div class="col-lg-10">
                                <select class="form-control" id="PersonnelPlaceID">
                                    @{ var perList = ViewData["PerList"] as List<ETexsys.Model.personnelplace>;}
                                    @foreach (var item in perList)
                                    {
                                        <option value="@item.ID">@item.PersonnelName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">角色</label>
                            <div class="col-lg-10">
                                <select class="form-control" id="RoleID">
                                    <option value="0"></option>
                                    @{ var roleList = ViewData["RoleList"] as List<ETexsys.Model.sys_role>;}
                                    @foreach (var item in roleList)
                                    {
                                        <option value="@item.RoleID">@item.RoleName</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">电话</label>
                            <div class="col-lg-10"><input type="text" id="Phone" class="form-control" /></div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">邮箱</label>
                            <div class="col-lg-10"><input type="text" id="Email" class="form-control" /></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="modal inmodal" id="myRightModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">用户权限</h4>
                </div>
                <form class="form-horizontal" id="addUserRoleForm">
                    <div class="modal-body">
                        <input type="hidden" id="addUserID" />
                        <table id="tb"></table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="selectedItem()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="myDataModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">数据权限</h4>
                </div>
                <form class="form-horizontal" id="addUserDataForm">
                    <div class="modal-body">
                        <input type="hidden" id="addUserDataID" />
                        <table id="td"></table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="SaveUserData()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="myWXWechat" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">扫描用户二维码，进行微信绑定</h4>
                </div>
                <form class="form-horizontal">
                    <div class="modal-body">
                        <div id="code" style="margin-left:90px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<script>

    $(document).ready(function () {
        var _url = "@Url.Action("GetSys_UserList", "Sys_User")";
        $('.dataTables-example').DataTable({
            bAutoWidth: false,
            aoColumns: [
               {
                   "sClass": "text-center",
                   "data": "UserID",
                   "render": function (data, type, full, meta) {
                       return '<input type="radio" name="a"  class="checkchild"  value="' + data + '" />';
                   },
                   "bSortable": false
               },
                { "sClass": "center", "mDataProp": "LoginName", "bSortable": false },
                 { "sClass": "center", "mDataProp": "UName", "bSortable": false },
                { "sClass": "center", "mDataProp": "RoleName", "bSortable": false },
                { "sClass": "center", "mDataProp": "StoreName", "bSortable": false },
                { "sClass": "center", "mDataProp": "OrganiseName", "bSortable": false },
                { "sClass": "center", "mDataProp": "PersonnelName", "bSortable": false },
                { "sClass": "center", "mDataProp": "Phone", "bSortable": false },
                { "sClass": "center", "mDataProp": "Email", "bSortable": false },
                {
                    "sClass": "text-center",
                    "data": "LastLoginTime",
                    "render": function (data, type, full, meta) {
                        return data != null ? data_string(data) : "";
                    },
                    "bSortable": false
                },
                { "sClass": "center", "mDataProp": "IsLevel", "bSortable": false },
                { "sClass": "center", "mDataProp": "WXOpenID", "bSortable": false },
            { "sClass": "center", "mDataProp": "UserID", "bSortable": false }
            ],
            "bServerSide": true,//分页，取数据等等的都放到服务端去
            "bProcessing": true,//载入数据的时候是否显示“载入中”
            "aLengthMenu": [30, 50, 100],
            "bLengthChange": false, //改变每页显示数据数量
            "bFilter": false, //过滤功能
            "iDisplayStart": 0,
            "iDisplayLength": 30,//首次加载的数据条数
            "bStorable": true,//排序操作在服务端进行，所以可以关了。
            "sAjaxSource": _url,
            "fnServerData": function (sSource, aoData, fnCallback, bStorable) {
                var paramList = {
                    "sEcho": 0,
                    "iDisplayLength": 0,
                    "iDisplayStart": 0,
                    "sSortDir_0": bStorable.aaSorting[0][1],
                    "iSortCol_0": bStorable.aaSorting[0][0],
                };
                if (bStorable.aaSorting[0][0] == 0) {
                    paramList.isDesc = true;
                }
                for (var i = 0; i < aoData.length; i++) {
                    if (aoData[i].name == "iDisplayStart") {
                        paramList.iDisplayStart = aoData[i].value;
                    } else if (aoData[i].name == "iDisplayLength") {
                        paramList.iDisplayLength = aoData[i].value;
                    } else
                        if (aoData[i].name == "sEcho") {
                            paramList.sEcho = aoData[i].value;
                        }
                }
                $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": sSource,
                    "data": paramList,
                    "success": function (resp) {
                        fnCallback(resp); //服务器端返回的对象的returnObject部分是要求的格式
                    }
                });
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                var state = "";
                var html = "";
                if (!aData.IsLevel) {
                    state = '<span class="label" style="background:#56af45;">正常</span>';
                    html = '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:ChangeUserState(\'' + aData.UserID + '\',1)" title=""><i class="fa fa-lock"></i>&nbsp;禁用</a>'
                } else {
                    state = '<span class="label" style="background:#f00;">禁用</span>';
                    html = '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:ChangeUserState(\'' + aData.UserID + '\',2)" title=""><i class="fa fa-unlock"></i>&nbsp;启用</a>'
                }
                html += '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:InitializePwd(\'' + aData.UserID + '\')" title="重置密码"><i class="fa fa-refresh"></i>&nbsp;重置</a><br/>'
                html += '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:RightSetting(\'' + aData.UserID + '\')" title="权限"><i class="fa fa-gears"></i>&nbsp;权限</a>'
                html += '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:DataSetting(\'' + aData.UserID + '\')" title="数据"><i class="fa fa-database"></i>&nbsp;数据</a>'
                $('td:eq(10)', nRow).html(state);
                $('td:eq(12)', nRow).html(html);

                var wx = "";
                if (aData.WXOpenID == undefined || aData.WXOpenID == "") {
                    wx = '<a class="btn btn-white btn-sm" style="margin-right:2px;color:#56af45;" href="javascript:WXQRCODE(\'' + aData.UserID + '\',1)" title=""><i class="fa fa-wechat"></i>&nbsp;绑定微信</a>'
                } else {
                    wx = '<a class="btn btn-white btn-sm" style="margin-right:2px;color:#f00;" href="javascript:WXQRCODE(\'' + aData.UserID + '\',2)" title=""><i class="fa fa-wechat"></i>&nbsp;解除绑定</a>'
                }
                $('td:eq(11)', nRow).html(wx);
            },
            dom: '<"html5buttons"B>lTfgitp',
            buttons: [
                { extend: 'copy' },
                { extend: 'csv' },
                { extend: 'excel', title: 'ExampleFile' },
                { extend: 'pdf', title: 'ExampleFile' },

                {
                    extend: 'print',
                    customize: function (win) {
                        $(win.document.body).addClass('white-bg');
                        $(win.document.body).css('font-size', '10px');

                        $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', 'inherit');
                    }
                }
            ],
            "oLanguage": {
                "sLengthMenu": "每页显示 _MENU_ 条记录",
                "sZeroRecords": "抱歉， 没有找到",
                "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                "sInfoEmpty": "没有数据",
                "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "前一页",
                    "sNext": "后一页",
                    "sLast": "尾页"
                },
                "sZeroRecords": "没有检索到数据",
                "sProcessing": "<img src='./loading.gif' />"
            }
        });
    });

    var goeasy = new GoEasy({
        appkey: config.goEasyAppKey
    });

    function DataSetting(id) {
        var _url = "@Url.Action("GetUserDataList", "Sys_User")";
        $("#td").empty();
        $('#td').treegridData({
            id: 'ID',
            parentColumn: 'ParentID',
            type: "GET", //请求数据的ajax类型
            url: _url,   //请求数据的ajax的url
            ajaxParams: { UserID: id }, //请求数据的ajax的data属性
            expandColumn: 1,//在哪一列上面显示展开按钮
            striped: true,   //是否各行渐变色
            bordered: true,  //是否显示边框
            expandAll: false,  //是否全部展开
            checkbox: true,
            columns: [{
                title: '',
                field: 'ID'
            },
              {
                  title: '名称',
                  field: 'RegionName'
              },
                {
                    title: '类型',
                    field: 'RegionTypeName'
                }
            ]
        });
        $("#myDataModal").modal('show');
        $("#addUserDataID").val(id);
    }

    function RightSetting(id) {
        var _url = "@Url.Action("GetUserRightList", "Sys_User")";
        $("#tb").empty();
        $('#tb').treegridData({
            id: 'RightID',
            parentColumn: 'RightParentID',
            type: "GET", //请求数据的ajax类型
            url: _url,   //请求数据的ajax的url
            ajaxParams: { UserID: id }, //请求数据的ajax的data属性
            expandColumn: 1,//在哪一列上面显示展开按钮
            striped: true,   //是否各行渐变色
            bordered: true,  //是否显示边框
            expandAll: false,  //是否全部展开
            checkbox: true,
            columns: [{
                title: '',
                field: 'RightID'
            },
              {
                  title: '功能名称',
                  field: 'RightName'
              },
                {
                    title: '系统模块',
                    field: 'ApplicationName'
                },
                {
                    title: '功能编码',
                    field: 'RightCode'
                },
                {
                    title: '操作',
                    field: 'RightBtn'
                }
            ]
        });
        $("#myRightModal").modal('show');
        $("#addUserID").val(id);
    }

    function AddModule() {
        $("#LoginName").attr("disabled", false);
        $("#LoginPwd").attr("disabled", false);
        $("#LoginName").nextAll().remove();
        $("#UserID").val("0");
        document.getElementById("addUserForm").reset();
        $(".modal-title").html("添加用户");
        $('#myModal').modal('show');
    }

    function UpdateModule() {
        $("#LoginName").nextAll().remove();
        var val = $(".dataTables-example input[type='radio']:checked").val();
        if (val == null) {
            swal("提示", "请先选择记录.");

            return false;
        }

        debugger;
        var url = "@Url.Action("GetUser", "Sys_User")";
        document.getElementById("addUserForm").reset();//清空表单
        $.ajax({
            type: "post",
            data: { UserID: val },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $(".modal-title").html("用户信息");
                    $("#UserID").val(result.Result.UserID);
                    $("#LoginName").val(result.Result.LoginName);
                    $("#UName").val(result.Result.UName);
                    $("#LoginPwd").val(result.Result.LoginPwd);
                    $("#StoreID").val(result.Result.StoreID);
                    $("#OrganiseID").val(result.Result.OrganiseID);
                    $("#PersonnelPlaceID").val(result.Result.PersonnelPlaceID);
                    $("#Phone").val(result.Result.Phone);
                    $("#RoleID").val(result.Result.RoleID);
                    $("#Email").val(result.Result.Email);
                    $("#LoginName").attr("disabled", "disabled");
                    $("#LoginPwd").attr("disabled", "disabled");
                    $('#myModal').modal('show');
                } else {
                    swal({ title: "提示", text: "获取信息失败", type: "error" });
                }
            }
        });
    }

    function WXQRCODE(userId, type) {
        if (type == "1") {
            var code = "@ViewData["Code"].ToString()";
            var timestamp = Date.parse(new Date());
            timestamp = timestamp / 1000;
            var txt = config.wxAuthorizeUrl + "Scan/B/?scode=" + code + "&userId=" + userId + "&t=" + timestamp;

            $("#code").empty();
            $("#code").qrcode({
                render: "table",
                width: 350,
                height: 350,
                text: txt
            });
            $("#myWXWechat").modal('show');

            goeasy.subscribe({
                channel: "bindingChannel_" + code + "_" + userId,
                onMessage: function (message) {
                    if (message.content == "OK") {
                        swal("Good!", "绑定成功", "success");
                        goeasy.unsubscribe({
                            channel: "bindingChannel_" + code + "_" + userId
                        });
                        $("#myWXWechat").modal('hide');
                        $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                    }
                }
            });
        } else {
            swal({
                title: "您确定要解除绑定吗？",
                text: "您确定要解除当前用户绑定？",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                closeOnConfirm: false
            }, function () {
                var url = "@Url.Action("UnBindingWX","Sys_User")";
                $.ajax({
                    type: "post",
                    data: { UserID: userId },
                    url: url,
                    async: false,
                    success: function (result) {
                        if (result.ResultCode == "0") {
                            swal("Good!", "解除成功", "success");
                            $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                        } else {
                            swal({ title: "提示", text: "解除失败", type: "error" });
                        }
                    }
                });
            });
        }
    }

    function DeleteModule() {
        var val = $(".dataTables-example input[type='radio']:checked").val();
        if (val == null) {
            swal("提示", "请先选择记录.");

            return false;
        }
        swal({
            title: "您确定要删除吗？",
            text: "您确定要删除这条数据？",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("DelSys_User","Sys_User")";
            $.ajax({
                type: "post",
                data: { UserID: val },
                url: url,
                async: false,
                success: function (result) {
                    if (result.ResultCode == "0") {
                        swal("Good!", "删除成功", "success");
                        $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                    } else {
                        swal({ title: "提示", text: "删除失败", type: "error" });
                    }
                }
            });
        });
    }

    function ChangeUserState(userId, type) {
        var title = ""; var text = "";
        if (type == 1) {
            title = "您确定要禁用吗？";
            text = "您确定要禁用当前用户吗？";
        } else {
            title = "您确定要启用吗？";
            text = "您确定要启用当前用户吗？";
        }
        swal({
            title: title,
            text: text,
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("ChangeUserState","Sys_User")";
            $.ajax({
                type: "post",
                data: { userId: userId },
                url: url,
                async: false,
                success: function (result) {
                    if (result.ResultCode == "0") {
                        swal("Good!", "操作成功", "success");
                        $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                    } else {
                        swal({ title: "提示", text: "操作失败", type: "error" });
                    }
                }
            });
        });
    }

    function InitializePwd(userId) {

        swal({
            title: "您确定要重置吗？",
            text: "您确定要重置当前用户密码吗？",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            cancelButtonText: "取消",
            closeOnConfirm: false
        }, function () {
            var url = "@Url.Action("InitializePwd", "Sys_User")";
            $.ajax({
                type: "post",
                data: { userId: userId, pwd: $.md5("123456") },
                url: url,
                async: false,
                success: function (result) {
                    if (result.ResultCode == "0") {
                        swal("Good!", "操作成功", "success");
                        $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                    } else {
                        swal({ title: "提示", text: "操作失败", type: "error" });
                    }
                }
            });
        });
    }
    function checkUserName(obj) {
        var url = "@Url.Action("CheckUserName", "Sys_User")";
        $.ajax({
            type: "post",
            data: { UserID: $("#UserID").val(), LoginName: $("#LoginName").val() },
            url: url,
            async: false,
            success: function (result) {
                if (result) {
                    $(obj).nextAll().remove();
                } else {
                    $(obj).nextAll().remove();
                    $(obj).after('<p class="help-block"  style="color:red">名称已存在</p>');
                }
            }
        });
    }

    $("#addUserForm").submit(function () {
        var _url = "@Url.Action("CheckUserName", "Sys_User")";
        $.ajax({
            type: "post",
            data: { UserID: $("#UserID").val(), LoginName: $("#LoginName").val() },
            url: _url,
            success: function (result) {
                if (result) {
                    $("#LoginName").nextAll().remove();
                    var pwd = $.md5($("#LoginPwd").val());
                    var url = "@Url.Action("AddSys_User","Sys_User")";
                    if ($("#UserID").val() != "0") {
                        url = "@Url.Action("UpdateSys_User", "Sys_User")";
                        pw = $("#LoginPwd").val();
                    }
                    debugger;
                    $.ajax({
                        type: "post",
                        data: {
                            UserID: $("#UserID").val(), LoginName: $("#LoginName").val(), LoginPwd: pwd, StoreID: $("#StoreID").val(), StoreType: $('#StoreID option:selected').attr("data-StoreType"),
                            OrganiseID: $("#OrganiseID").val(), PersonnelPlaceID: $("#PersonnelPlaceID").val(),
                            UName: $("#UName").val(), Phone: $("#Phone").val(), Email: $("#Email").val(), RoleID: $("#RoleID").val(), UName: $("#UName").val()
                        },
                        url: url,
                        async: false,
                        success: function (result) {
                            if (result.ResultCode == "0") {
                                $('#myModal').modal('hide');//关闭模态框
                                document.getElementById("addUserForm").reset();//清空表单
                                $(".dataTables-example").dataTable().fnDraw();//点搜索重新绘制table。
                            } else {
                                swal({
                                    title: "提示",
                                    text: "添加失败"
                                });
                            }
                        }
                    });
                } else {
                    $("#RoleName").nextAll().remove();
                    $("#RoleName").after('<p class="help-block"  style="color:red">名称已存在</p>');
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                var i = 0;
                debugger;
            }
        });
        return false;
    });

    function selectedItem() {
        var rightIds = "";
        $('#tb input[type="checkbox"][data-type="1"]:checkbox:checked').each(function () {
            rightIds += $(this).val() + "|"
        });
        var rightBtns = "";
        $('#tb input[type="checkbox"][data-type="2"]:checkbox:checked').each(function () {
            rightBtns += $(this).val() + "|"
        });
        var userId = $("#addUserID").val();
        var url = "@Url.Action("SetUserRight", "Sys_User")";
        $.ajax({
            type: "post",
            data: { userId: userId, rightIds: rightIds, rightBtns: rightBtns },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $('#myRightModal').modal('hide');
                } else {
                    swal({ title: "提示", text: "设置失败", type: "error" });
                }
            }
        });

    }

    function SaveUserData() {
        var regionIds = "";
        $('#td input[type="checkbox"][data-type="1"]:checkbox:checked').each(function () {
            regionIds += $(this).val() + "|"
        });
        var userId = $("#addUserDataID").val();
        var url = "@Url.Action("SetUserDataView", "Sys_User")";
        $.ajax({
            type: "post",
            data: { userId: userId, regionIds: regionIds },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $('#myDataModal').modal('hide');
                } else {
                    swal({ title: "提示", text: "设置失败", type: "error" });
                }
            }
        });
    }
</script>
