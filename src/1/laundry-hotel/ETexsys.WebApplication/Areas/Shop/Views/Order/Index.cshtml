@{
    Layout = null;
}
<link href="@Url.Content("~/Content/plugins/daterangepicker/daterangepicker.css")" rel="stylesheet" />
<div class="row wrapper wrapper-content animated fadeInRight" style="padding-top:75px;">
    <div class="ibox-content">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-lg-1 control-label" style="font-weight: bold; font-family: 微软雅黑;">订单号</label>
                <div class="col-lg-2">
                    <input class="form-control" id="txtOrderNo" type="text" placeholder="" />
                </div>
                <label class="col-lg-1 control-label" style="font-weight: bold; font-family: 微软雅黑;">订单状态</label>
                <div class="col-lg-2">
                    <select id="status" class="form-control">
                        <option value="0" selected="selected">不限</option>
                        <option value="1">待处理</option>
                        <option value="2">已确定</option>
                        <option value="3">已配货</option>
                        <option value="4">已完成</option>
                    </select>
                </div>
                <label class="col-lg-1 control-label" style="font-weight: bold; font-family: 微软雅黑;">酒店</label>
                <div class="col-lg-2">
                    <select id="queryHotelId" class="form-control">
                        <option value="0" selected="selected">所有</option>
                        @{ var hotelList = ViewData["HotelList"] as List<ETexsys.Model.region>;}
                        @foreach (var item in hotelList)
                        {
                            <option value="@item.ID">@item.RegionName</option>
                        }
                    </select>
                </div>
            </div>
            <div class="form-group">

                <label class="col-lg-1 control-label" style="font-weight: bold; font-family: 微软雅黑;">支付方式</label>
                <div class="col-lg-2">
                    <select id="paytype" class="form-control">
                        <option value="0">不限</option>
                        <option value="1">未支付</option>
                        <option value="2">线上支付</option>
                        <option value="3">货到付款</option>
                    </select>
                </div>
                <label class="col-lg-1 control-label" style="font-weight: bold; font-family: 微软雅黑;">下单时间</label>
                <div class="col-lg-3">
                    <div class="input-group" style="width: 240px; margin-left: -5px;">
                        <input type="text" class="form-control date-picker" id="dateTimeRange" value="" />
                        <span class="input-group-addon">
                            <i class="fa fa-calendar bigger-110"></i>
                        </span>
                        <input type="hidden" name="beginTime" id="beginTime" value="" />
                        <input type="hidden" name="endTime" id="endTime" value="" />
                    </div>
                </div>
                <button class="btn btn-success" onclick="Search()"><i class="fa fa-search"></i>搜索</button>

            </div>
        </div>
    </div>

    <div class="ibox-content" style="margin-top:20px; overflow:hidden;">
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover dataTables-example">
                <thead>
                    <tr>
                        <th>订单号</th>
                        <th>酒店</th>
                        <th>订单状态</th>
                        <th>支付类型</th>
                        <th>下单时间</th>
                        <th>期望送达时间</th>
                        <th>配货时间</th>
                        <th>送达时间</th>
                        <th>配送人员</th>
                        <th>发货</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="modal inmodal" id="myDistributionModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">物流配送</h4>
                </div>
                <form class="form-horizontal" id="distributionForm">
                    <div class="modal-body">
                        <div class="form-group">
                            <input type="hidden" id="hidDisOrderId" value="" />
                            <label class="col-lg-2 control-label">配送人员</label>
                            <div class="col-lg-10">
                                <input id="txtDistributor" class="form-control" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-2 control-label">联系电话</label>
                            <div class="col-lg-10">
                                <input id="txtDistributorTel" class="form-control" type="text" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    @RenderPage("Detail.cshtml")
</div>
<script src="@Url.Content("~/Scripts/plugins/daterangepicker/moment.js")"></script>
<script src="@Url.Content("~/Scripts/plugins/daterangepicker/daterangepicker.js")"></script>
<script>

    $(document).ready(function () {
        $('#dateTimeRange').daterangepicker({
            applyClass: 'btn-sm btn-success',
            cancelClass: 'btn-sm btn-default',
            locale: {
                applyLabel: '确认',
                cancelLabel: '取消',
                fromLabel: '起始时间',
                toLabel: '结束时间',
                customRangeLabel: '自定义',
                firstDay: 1
            },
            ranges: {
                '今日': [moment().startOf('day'), moment()],
                '昨日': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
                '最近7日': [moment().subtract('days', 6), moment()],
                '最近30日': [moment().subtract('days', 29), moment()],
                '本月': [moment().startOf("month"), moment().endOf("month")],
                '上个月': [moment().subtract(1, "month").startOf("month"), moment().subtract(1, "month").endOf("month")]
            },
            startDate: moment().startOf("month"),
            endDate: moment().endOf("month"),
            opens: 'right',    // 日期选择框的弹出位置
            separator: ' 至 ',
            showWeekNumbers: false,     // 是否显示第几周
            locale: {
                applyLabel: '确定',
                cancelLabel: '取消',
                fromLabel: '起始时间',
                toLabel: '结束时间',
                customRangeLabel: '自定义',
                daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
                        '七月', '八月', '九月', '十月', '十一月', '十二月'],
                firstDay: 1
            },
            //timePicker: true,
            //timePickerIncrement : 10, // 时间的增量，单位为分钟
            //timePicker12Hour : false, // 是否使用12小时制来显示时间
            //maxDate : moment(),           // 最大时间
            format: 'YYYY-MM-DD'

        }, function (start, end, label) { // 格式化日期显示框
            $('#beginTime').val(start.format('YYYY-MM-DD'));
            $('#endTime').val(end.format('YYYY-MM-DD'));
        })
       .next().on('click', function () {
           $(this).prev().focus();
       });
        var url = "@Url.Action("GetOrderList", "Order")";
        $('.dataTables-example').DataTable({
            bAutoWidth: false,
            aoColumns: [
                { "sClass": "center", "mDataProp": "OrderNo", "bSortable": false },
                { "sClass": "center", "mDataProp": "HotelName", "bSortable": false },
                { "sClass": "center", "mDataProp": "OrderState", "bSortable": false },
                { "sClass": "center", "mDataProp": "PaymentType", "bSortable": false },
                {
                    "sClass": "text-center",
                    "data": "CreateTime",
                    "render": function (data, type, full, meta) {
                        return data_string(data);//date的格
                    },
                    "bSortable": false
                },
                { "sClass": "center", "mDataProp": "DeliveryTime", "bSortable": false },
                {
                    "sClass": "text-center",
                    "data": "DistributionTime",
                    "render": function (data, type, full, meta) {
                        return data_string(data);//date的格
                    },
                    "bSortable": false
                }, {
                    "sClass": "text-center",
                    "data": "SignTime",
                    "render": function (data, type, full, meta) {
                        return data_string(data);//date的格
                    },
                    "bSortable": false
                }, { "sClass": "center", "mDataProp": "Distributor", "bSortable": false }
                , { "sClass": "center", "mDataProp": "ID", "bSortable": false }
            ],
            "bServerSide": true,//分页，取数据等等的都放到服务端去
            "bProcessing": true,//载入数据的时候是否显示“载入中”
            "aLengthMenu": [30, 50, 100],
            "bLengthChange": false, //改变每页显示数据数量
            "bFilter": false, //过滤功能
            "iDisplayStart": 0,
            "iDisplayLength": 30,//首次加载的数据条数
            "bStorable": true,//排序操作在服务端进行，所以可以关了。
            "sAjaxSource": url,
            "fnServerData": function (sSource, aoData, fnCallback, bStorable) {
                var paramList = {
                    "sEcho": 0,
                    "iDisplayLength": 0,
                    "iDisplayStart": 0,
                    "sSortDir_0": bStorable.aaSorting[0][1],
                    "iSortCol_0": bStorable.aaSorting[0][0],
                    "qCondition1": $("#txtOrderNo").val(),
                    "qCondition2": $("#status").val(),
                    "qCondition3": $("#queryHotelId").val(),
                    "qCondition4": $("#paytype").val(),
                    "qCondition5": $("#beginTime").val(),
                    "qCondition6": $("#endTime").val()
                };
                if (bStorable.aaSorting[0][0] == 0) {
                    paramList.isDesc = true;
                }
                for (var i = 0; i < aoData.length; i++) {
                    if (aoData[i].name == "iDisplayStart") {
                        paramList.iDisplayStart = aoData[i].value;
                    } else if (aoData[i].name == "iDisplayLength") {
                        paramList.iDisplayLength = aoData[i].value;
                    } else
                        if (aoData[i].name == "sEcho") {
                            paramList.sEcho = aoData[i].value;
                        }
                }
                $.ajax({
                    "dataType": 'json',
                    "type": "POST",
                    "url": sSource,
                    "data": paramList,
                    "success": function (resp) {
                        fnCallback(resp); //服务器端返回的对象的returnObject部分是要求的格式
                    }
                });
            },
            "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                var html = "<a href=\"javascript:SelectDetail('" + aData.ID + "')\">" + aData.OrderNo + "</a>";
                $('td:eq(0)', nRow).html(html);
                var statename = aData.OrderState == 1 ? '<span class="label" style="background:#f00;color:#fff;">未处理</span>' : (aData.OrderState == 2 ? "已确认" : (aData.OrderState == 3 ? "已配货" : "已完成"));
                $('td:eq(2)', nRow).html(statename);
                var paytype = aData.PaymentType == 1 ? "未付款" : (aData.PaymentType == 2 ? "线上支付" : "货到付款");
                $('td:eq(3)', nRow).html(paytype);
                $('td:eq(5)', nRow).html(data_string(aData.DeliveryDate).substring(0, 10) + " " + aData.DeliveryTime);
                if (aData.OrderState == 2) {
                    html = '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:Distribution(\'' + aData.ID + '\')" title="配货"><i class="fa fa-truck"></i>&nbsp;配货</a>';
                    $('td:eq(9)', nRow).html(html);
                } else if (aData.OrderState == 3) {
                    html = '<a class="btn btn-white btn-sm" style="margin-right:2px;" href="javascript:SignOrder(\'' + aData.ID + '\')" title="签收"><i class="fa fa-truck"></i>&nbsp;签收</a>';
                    $('td:eq(9)', nRow).html(html);
                }
                else {
                    $('td:eq(9)', nRow).html("");
                }
            },
            dom: '<"html5buttons"B>lTfgitp',
            buttons: [
                { extend: 'copy' },
                { extend: 'csv' },
                { extend: 'excel', title: 'ExampleFile' },
                { extend: 'pdf', title: 'ExampleFile' },
                {
                    extend: 'print',
                    customize: function (win) {
                        $(win.document.body).addClass('white-bg');
                        $(win.document.body).css('font-size', '10px');

                        $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', 'inherit');
                    }
                }
            ],
            "oLanguage": {
                "sLengthMenu": "每页显示 _MENU_ 条记录",
                "sZeroRecords": "抱歉， 没有找到",
                "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
                "sInfoEmpty": "没有数据",
                "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "前一页",
                    "sNext": "后一页",
                    "sLast": "尾页"
                },
                "sZeroRecords": "没有检索到数据",
                "sProcessing": "<img src='./loading.gif' />"
            }
        });

    });

    function Search() {
        $('.dataTables-example').dataTable().fnDraw();//点查询重新绘制table。
    }

    /**
    * 清除时间
    */
    function begin_end_time_clear() {
        $('#dateTimeRange').val('');
        $('#beginTime').val('');
        $('#endTime').val('');
    }

    function Distribution(id) {
        $("#hidDisOrderId").val(id);
        $("#txtDistributor").val('');
        $("#txtDistributorTel").val('');
        $('#myDistributionModal').modal('show');
    }

    function SelectDetail(bid) {
        var url = "@Url.Action("GetOrderDetail", "Order")";
        $.ajax({
            type: "post",
            data: { id: bid },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    var d = result.Result;
                    $("#hidOrderID").val(d.OrderId);
                    $("#lblOrderNo").html(d.OrderNo);
                    $("#lblHotelName").html(d.HotelName);
                    $("#lblStateName").html(d.StateName);
                    $("#lblPaymentTypeName").html(d.PaymentName);
                    $("#lblDelivery").html(d.Delivery);
                    $("#lblCreateTime").html(d.CreateTime);
                    $("#lblComfirmTime").html(d.ComfirmTime);
                    $("#lblDistributionTime").html(d.DistributonTime);
                    $("#lblSignTime").html(d.SignTime);
                    $("#lblDistributor").html(d.Distributor);
                    $("#lblGoodsTotal").html(d.GoodsTotal);
                    $("#lblGoodsTotalPrice").html(d.GoodsTotalMoney);

                    if (d.State == 1) {
                        $("#btnSubmit").show();
                    } else {
                        $("#btnSubmit").hide();
                    }

                    $("#order-table-detail tbody").empty();
                    var detail = d.Detail;
                    $.each(detail, function (i, item) {
                        var tr = $('<tr></tr>');
                        var textiletd = $('<td></td>');
                        $(textiletd).html(item.GoodsName).appendTo(tr);
                        var sizetd = $('<td style="text-align:right;padding-right:5px;"></td>');
                        $(sizetd).html(item.GoodsCount).appendTo(tr);
                        var count = $('<td style="text-align:right;padding-right:5px;"></td>');
                        $(count).html(item.GoodsPrice).appendTo(tr);
                        $(tr).appendTo($("#order-table-detail tbody"));
                    });

                    $('#myModal').modal('show');
                }
            }
        });
    }

    $("#btnSubmit").on("click", function () {
        var url = "@Url.Action("OrderConfirm", "Order")";
        $.ajax({
            type: "post",
            data: { id: $("#hidOrderID").val() },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $("#lblStateName").html("已确认");
                    $("#btnSubmit").hide();
                    $('.dataTables-example').dataTable().fnDraw();//点查询重新绘制table。
                } else {
                    swal({
                        title: "提示",
                        text: "服务器异常"
                    });
                }
            }
        });
    });

    $("#distributionForm").submit(function () {
        var url = "@Url.Action("OrderDistribution", "Order")";
        $.ajax({
            type: "post",
            data: { id: $("#hidDisOrderId").val(), name: $("#txtDistributor").val(), tel: $("#txtDistributorTel").val() },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $('.dataTables-example').dataTable().fnDraw();//点查询重新绘制table。
                    $('#myDistributionModal').modal('hide');
                } else {
                    swal({
                        title: "提示",
                        text: "服务器异常"
                    });
                }
            }
        });

        return false;
    });

    function SignOrder(bid) {
        var url = "@Url.Action("OrderSign", "Order")";
        $.ajax({
            type: "post",
            data: { id: bid },
            url: url,
            async: false,
            success: function (result) {
                if (result.ResultCode == "0") {
                    $('.dataTables-example').dataTable().fnDraw();//点查询重新绘制table。
                } else {
                    swal({
                        title: "提示",
                        text: "服务器异常"
                    });
                }
            }
        });
    }
</script>
